<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bible Character Timeline</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 2rem;
    }
    .timeline-chart {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
    }
    .axis-path {
      stroke: #333;
    }
    .axis-tick line {
      stroke: #ccc;
    }
    .axis-tick text {
      fill: #555;
      font-size: 12px;
    }
    .period-rect {
      /* fill is now set dynamically by D3 */
      stroke: rgba(0,0,0,0.5);
      stroke-width: 1px;
      opacity: 0.8;
    }
    .period-label {
      font-size: 14px;
      fill: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      pointer-events: none; /* So the label doesn't block mouse events on the rect */
    }
    .marker-line {
      stroke: #888;
      stroke-width: 1px;
      stroke-dasharray: 4 2;
    }
    .marker-label {
      fill: #666;
      font-size: 12px;
      text-anchor: middle;
    }
    .marker-label .year {
      font-weight: bold;
    }
    .tooltip {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      background-color: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      color: #333;
      transition: opacity 0.2s;
    }
    .controls {
      display: flex;
      gap: 2rem;
      margin-top: 2rem;
    }
    .controls h3 {
      margin: 0 0 0.5rem 0;
    }
    #period-controls, #marker-controls {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>

<h1>Bible character timeline</h1>
<svg id="timeline-chart" class="timeline-chart"></svg>
<div class="controls">
  <h3>Periods</h3>
  <div id="period-controls"></div>
  <h3>Markers</h3>
  <div id="marker-controls"></div>
</div>

<script>
  // --- Data ---
  const allPeriods = [
    { label: "Adam", startYear: -4026, endYear: -3096 },
    { label: "Enoch", startYear: -3404, endYear: -3039 },
    { label: "Noah", startYear: -2970, endYear: -2020 },
    { label: "Shem", startYear: -2468, endYear: -1868 },
    { label: "Abraham", startYear: -2018, endYear: -1843 },
    { label: "Sarah", startYear: -2008, endYear: -1881 },
    { label: "Isaac", startYear: -1918, endYear: -1738 },
    { label: "Jacob", startYear: -1858, endYear: -1711 },
    { label: "Joseph", startYear: -1767, endYear: -1657 },
    { label: "Moses", startYear: -1593, endYear: -1473 },
  ];

  const markerData = [
    { year: -2370, label: "Flood" },
    // { year: -1553, label: "Moses flees" },
    { year: -1513, label: "Exodus" },
    { year: -1473, label: "Promised land" },
  ];

  let visiblePeriods = [...allPeriods];

  // --- Controls ---
  const periodControls = d3.select("#period-controls");
  periodControls.selectAll("label")
    .data(allPeriods)
    .enter()
    .append("label")
    .html(d => `<input type="checkbox" class="period-toggle" value="${d.label}" checked> ${d.label}`);

  const markerControls = d3.select("#marker-controls");
  markerControls.selectAll("label")
    .data(markerData)
    .enter()
    .append("label")
    .html(d => `<input type="checkbox" class="marker-toggle" value="${d.label}" checked> ${d.label}`);

  // --- Chart Setup ---
  const margin = { top: 80, right: 50, bottom: 50, left: 50 };
  const width = 1000 - margin.left - margin.right;
  const height = 300 - margin.top - margin.bottom;

  const svg = d3.select("#timeline-chart")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

  // --- Scales ---
  const xScale = d3.scaleLinear().range([0, width]);
  const yScale = d3.scaleBand().range([0, height]).padding(0.2);
  const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(allPeriods.map(d => d.label));

  // --- Axes ---
  const xAxis = d3.axisBottom(xScale).ticks(10).tickFormat(d => `${Math.abs(d)} B.C.E.`);
  const xAxisGroup = svg.append("g")
    .attr("class", "x-axis")
    .attr("transform", `translate(0, ${height})`);

  // --- Groups for chart elements ---
  const chartGroup = svg.append("g");
  const markerGroup = svg.append("g").attr("class", "markers");

  // --- Tooltip ---
  const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip");

  function update() {
    // 1. Update scales based on visible data
    const minYear = d3.min(visiblePeriods, d => d.startYear);
    const maxYear = d3.max(visiblePeriods, d => d.endYear);
    const padding = (maxYear - minYear) * 0.05;
    xScale.domain([minYear - padding, maxYear + padding]);
    yScale.domain(visiblePeriods.map(d => d.label));

    // 2. Redraw X-axis
    xAxisGroup.transition().duration(750).call(xAxis);

    // 3. Data Join for period groups (rect + text)
    const periodGroups = chartGroup.selectAll("g.period-group")
      .data(visiblePeriods, d => d.label);

    // EXIT old elements
    periodGroups.exit()
      .transition().duration(750)
      .style("opacity", 0)
      .remove();

    // ENTER new elements
    const enterGroups = periodGroups.enter()
      .append("g")
      .attr("class", "period-group")
      .style("opacity", 0);

    enterGroups.append("rect")
      .attr("class", "period-rect")
      .attr("data-label", d => d.label)
      .style("fill", d => colorScale(d.label))
      .on("mouseover", (event, d) => tooltip.style("opacity", 1))
      .on("mousemove", (event, d) => {
        tooltip.html(`<strong>${d.label}</strong><br>${Math.abs(d.startYear)} - ${Math.abs(d.endYear)} B.C.E. (${Math.abs(d.startYear - d.endYear)} years)`)
          .style("left", (event.pageX + 15) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0));

    enterGroups.append("text")
      .attr("class", "period-label")
      .attr("text-anchor", "middle")
      .attr("dy", "0.35em")
      .text(d => d.label);

    // MERGE enter and update selections
    const mergedGroups = enterGroups.merge(periodGroups);

    mergedGroups.transition().duration(750)
      .style("opacity", 1);

    mergedGroups.select("rect.period-rect")
      .transition().duration(750)
      .attr("x", d => xScale(d.startYear))
      .attr("y", d => yScale(d.label))
      .attr("width", d => xScale(d.endYear) - xScale(d.startYear))
      .attr("height", yScale.bandwidth());

    mergedGroups.select("text.period-label")
      .transition().duration(750)
      .attr("x", d => xScale(d.startYear) + (xScale(d.endYear) - xScale(d.startYear)) / 2)
      .attr("y", d => yScale(d.label) + yScale.bandwidth() / 2);

    // 4. Update markers to reflect new xScale
    markerGroup.selectAll(".marker-line")
      .data(markerData)
      .transition().duration(750)
      .attr("x1", d => xScale(d.year))
      .attr("x2", d => xScale(d.year));

    markerGroup.selectAll(".marker-label")
      .data(markerData)
      .transition().duration(750)
      .attr("x", d => xScale(d.year))
      .selectAll("tspan.year")
      .attr("x", d => xScale(d.year));
  }

  // --- Initial Drawing and Marker Setup ---
  // This part only runs once
  const markerRowY1 = -20;
  const markerRowY2 = -50;

  markerGroup.selectAll("line.marker-line")
    .data(markerData)
    .enter()
    .append("line")
      .attr("class", "marker-line")
      .attr("y1", (d, i) => (i % 2 === 0 ? markerRowY2 + 5 : markerRowY1 + 5))
      .attr("y2", height);

  const markerLabels = markerGroup.selectAll("text.marker-label")
    .data(markerData)
    .enter()
    .append("text")
      .attr("class", "marker-label")
      .attr("y", (d, i) => (i % 2 === 0 ? markerRowY2 : markerRowY1));

  markerLabels.append("tspan").text(d => d.label);
  markerLabels.append("tspan")
      .attr("class", "year")
      .attr("dy", "1.2em")
      .text(d => `(${Math.abs(d.year)} B.C.E.)`);

  update(); // Initial draw

  // --- Event Handlers ---
  d3.selectAll(".period-toggle").on("change", function() {
    const label = d3.select(this).property("value");
    if (this.checked) {
      if (!visiblePeriods.find(p => p.label === label)) {
        visiblePeriods.push(allPeriods.find(p => p.label === label));
        visiblePeriods.sort((a, b) => allPeriods.findIndex(p => p.label === a.label) - allPeriods.findIndex(p => p.label === b.label));
      }
    } else {
      visiblePeriods = visiblePeriods.filter(p => p.label !== label);
    }
    update();
  });

  d3.selectAll(".marker-toggle").on("change", function() {
    const isChecked = d3.select(this).property("checked");
    const label = d3.select(this).property("value");
    markerGroup.selectAll(`.marker-line, .marker-label`).filter(d => d.label === label)
      .transition().duration(300)
      .style("opacity", isChecked ? 1 : 0);
  });

</script>

</body>
</html>
